# Пользователи и группы Linux

## Управление пользователями

Информация о пользователях находится в файле `/etc/passwd`. Чтобы узнать список всех пользователей в системе выполним команду:
```sh
cat /etc/passwd
```
На каждого пользователя выделена отдельная строка, имеющая следующий формат:
```
account:password:UID:GID:GECOS:directory:shell
```
где:
* `accont` - имя пользователя
* `password` - пароль пользователя
* `UID` - идентификационный номер пользователя
* `GID` - идентификационный номер освной группы пользователя
* `GECOS` - необязательное поле, используемое для указания дополнительной информации о пользователе (например, полное имя пользователя)
* `directory` - домашный каталог ($HOME) пользователя
* `shell` - командный интерпретатор пользователя (обычно /bin/bash)

> 
>```
>ls -la /etc/passwd
>-rw-r--r-- 1 root root 2222 сен  9 18:16 /etc/passwd
>```
> Файл `passwd` доступен для чтения всем, поэтому хранить в нём пароли небезопасно. С целью сохранить секретность, в поле `password` находится символ `x`, указываюший на то, что пароль сохранён в файле с ограниченным доступом `/etc/shadow`.

Посмотреть список всех пользователей, которые вошли в систему можно командой `who`.

Чтобы добавить пользователя необходимо использовать команду `useradd`.
```sh
useradd user0
```
Команда создан в системе нового пользователя `user0` с настройками пользователя по-умолчанию. Чтобы изменить настройки создаваемого пользователя необходимо использовать следующие ключи.

| Ключ |                                                                                                                                Описание                                                                                                                                |
|:----:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|  -b  |                                                                                  Базовый каталог. Это каталог, в котором будет создана домашняя папка пользователя. По умолчанию /home                                                                                 |
|  -с  |                                                                                                          Комментарий. В нем вы можете напечатать любой текст.                                                                                                          |
|  -d  |                                                                                    Название домашнего каталога. По умолчанию название совпадает с именем создаваемого пользователя.                                                                                    |
|  -e  |                                                                                 Дата, после которой пользователь будет отключен. Задается в формате ГГГГ-ММ-ДД. По умолчанию отключено.                                                                                |
|  -f  | Количество дней, которые должны пройти после устаревания пароля до блокировки пользователя, если пароль не будет изменен (период неактивности). Если значение равно 0, то запись блокируется сразу после устаревания пароля, при -1 - не блокируется. По умолчанию -1. |
|  -g  |                                              Первичная группа пользователя. Можно указывать как GID, так и имя группы. Если параметр не задан будет создана новая группа название которой совпадает с именем пользователя.                                             |
|  -G  |                                                                                                Список вторичных групп в которых будет находится создаваемый пользователь                                                                                               |
|  -k  |                                                                         Каталог шаблонов. Файлы и папки из этого каталога будут помещены в домашнюю папку пользователя. По умолчанию /etc/skel.                                                                        |
|  -m  |                                                                                   Ключ, указывающий, что необходимо создать домашнюю папку. По умолчанию домашняя папка не создается.                                                                                  |
|  -p  |                                                                   Зашифрованный пароль пользователя. По умолчанию пароль не задается, но учетная пользователь будет заблокирован до установки пароля                                                                   |
|  -s  |                                                                                                       Оболочка, используемая пользователем. По умолчанию /bin/sh.                                                                                                      |
|  -u  |                                                                                                                    Вручную задать UID пользователю.                                                                                                                    |

Настройки создания пользователя по умолчанию возможно посмотреть следующей командой `useradd -D`.
Если настройки пользователя по-умолчанию не устраивают, то их возможно изменить командой:
```sh
useradd -D <ключ> <параметр> ...
```
Ключи из таблицы выше.
Изменение параметров пользователя происходит с помощью утилиты `usermod`. Пример использования:
```
usermod -c "Эта команда поменяет комментарий пользователю" user0
```
`usermod` использует те же опции, что и `useradd`.

Чтобы изменить пароль пользователя выполнил команду
```sh
passwd user0
```
Основные ключи команды `passwd`:

| Ключ |                                                            Описание                                                            |
|:----:|:------------------------------------------------------------------------------------------------------------------------------:|
|  -d  | Удалить пароль пользователю. После этого пароль будет пустым, и пользователь сможет входить в систему без предъявления пароля. |
|  -e  |               Сделать пароль устаревшим. Это заставит пользователя изменить пароль при следующем входе в систему.              |
|  -i  |          Заблокировать учетную запись пользователя по прошествии указанного количества дней после устаревания пароля.          |
|  -n  |                                        Минимальное количество дней между сменами пароля.                                       |
|  -x  |                       Максимальное количество дней, после которого необходимо обязательно сменить пароль.                      |
|  -l  |                                           Заблокировать учетную запись пользователя.                                           |
|  -u  |                                           Разблокировать учетную запись пользователя.                                          |

Супер-пользователь с помощью утилит `passwd` и `usermod` или путем редактирования файла `/etc/shadow` может удалить пароль пользователя, дав возможность входить в систему без указания пароля.
```
passwd -d vasyapupkin
```
или
```
usermod -p "" vasyapupkin
```

**Получение информации о пользователях**
* `w` - вывод информации (имя пользователя, рабочий терминал, время входа в систему, информацию о потребленных ресурсах CPU и имя запущенной программы) о всех вошедших в систему пользователях.
* `who` – вывод информации (имя пользователя, рабочий терминал, время входа в систему) о всех вошедших в систему пользователях.
* `whoami` - вывод вашего имени пользователя.
* `users` - вывод имен пользователей, работающих в системе.
* `id <имя пользователя>` - вывод о идентификаторах пользователя: его uid, имя_пользователя, gid и имя первичной группы и список групп в которых состоит пользователь
* `groups <имя пользователя>` – вывод списка групп в которых состоит пользователь.

Для этого чтобы удалить пользователя воспользуемся утилитой `userdel`:
```sh
userdel user0
```
Ключи `userdel`:

| Ключ |                                   Описание                                   |
|:----:|:---------------------------------------------------------------------------:|
|  -f  | Принудительно удалить пользователя, даже если он сейчас работает в системе. |
|  -r  |                    Удалить домашний каталог пользователя.                   |

## Управление группами

`/etc/group` - файл, хранящий информацию о группах пользователей.
Чтобы отобразить группы, в которые включен пользователь, можно использовать команду `groups`:
```sh
groups <имя_пользователя>
```
Используя команду `id` можно получить дополнительную информацию, такую как ID пользователя и его групп (UID и GID):
```sh
id <имя_пользователя>
```
Отобразить список всех групп:
```sh
cat /etc/groups
```
Добавить новую группу командой `groupadd`:
```sh
groupadd <имя_группы>
```
Ключи `groupadd`:

| Ключ |                                                                                                                                       Описание                                                                                                                                       |
|:----:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|  -f  |            Завершить работу и вернуть состояние успешного выполнения, если группа уже существует. Если            используется вместе с параметром -g и указанный GID уже существует, то выбирается другой            (уникальный) GID (то есть параметр -g игнорируется).           |
|  -g  | Числовое значение идентификатора группы (ID). Оно должно быть уникальным, если не            используется параметр -o. Значение должно быть неотрицательным. По умолчанию используется            наименьшее значение ID большее или равное GID_MIN и большее чем у остальных групп. |
|  -h  |                                                                                                                     Показать краткую справку и закончить работу.                                                                                                                     |
|  -K  |                                             Изменить значения по умолчанию (GID_MIN, GID_MAX и другие), которые хранятся в файле            /etc/login.defs. Можно указать несколько параметров -K. Пример: -K GID_MIN=100 -K GID_MAX=499                                            |
|  -o  |                                                                                                                   Разрешить добавление группы с не уникальным GID.                                                                                                                   |
|  -p  |                                                                                      Шифрованное значение пароля, которое возвращает функция crypt(3). По умолчанию пароль            отключён.                                                                                      |
|  -r  |                                                                                                                               Создать системную группу.                                                                                                                              |
|  -R  |                                                                                      Выполнить изменения в каталоге КАТ_CHROOT и использовать файлы настройки из каталога            КАТ_CHROOT.                                                                                     |

Сменить название группы, её GID или пароль можно при помощи `groupmod`. Пример:

```sh
groupmod -n <новое_имя> <имя_группы>
```

Ключи команду `groupmod`:

| Ключ |                                             Описание                                             |
|:----:|:------------------------------------------------------------------------------------------------:|
|  -g  |                            Имя группы будет изменено с ГРУППА на GID.                            |
|  -h  |                           Показать краткую справку и закончить работу.                           |
|  -n  |                        Имя группы будет изменено с ГРУППА на НОВАЯ_ГРУППА.                       |
|  -o  |    При использовании с параметром -g разрешается изменять GID группы не уникальным значением.    |
|  -p  |                 Шифрованное значение пароля, которое возвращает функция crypt(3).                |
|  -R  | Выполнить изменения в каталоге КАТ_CHROOT и использовать файлы настройки из каталога КАТ_CHROOT. |

Удаление группы производится с помощью команду `groupdel`:
```sh
groupdel <имя_группы>
```

### Задание

1. Создать группы пользователей:
   - tpk_user
   - tpk_test
   - tpk_admin

2. Создать пользователя c характеристиками:
- Имя пользователя: tpkpractic
- Путь к домашней директории: /home/tpkpractic
- Путь к интерпретатору для пользователя tpkpractic установить /bin/false
- Добавить пользователя в 2 группы:
   - группа tpk_users
   - группа tpk_test
- Прописать несуществующий интерпретатор в системе

3. Создать пользователя с характеристиками.
Имя пользователя: tpkpractic2
Путь к домашней папке: /home/ptkpractic2
Путь к интерпретатору: /bin/bash
Добавить пользователя в две группы:
    - tpk_users
    - tpk_admin 

4. Создать файл /home/tpkpractic/test_file и настроить на него права таким образом, чтобы пользователь tpkpractic2 мог этот файл прочитать и записать, пользователь tpkpractic и все остальные только прочитать.

5. Создать при помощи цикла for 10 пользователей с именами user[0-9] со своими домашними папками и паролям. Все пользователи должны быть членами группы allusers.

Результат выполнения задачи - команда (или текст скрипта) создания и вывод выполнения - 3 колонки:
<UserName> <HomerDir> <Password (min 8 symbols)>

6. Настроить sudo для пользователя tpkpractic2, а именно дать разрешение на выполнение без пароля команды usermod (результат выполнения задания - содержимое файла настроек sudo  и работающая команда)

7. В приветствии ДО авторизации пользователя по SSH вывести свое приветствие, с указанием того кто выполняет работу

8. В приветствии ПОСЛЕ авторизации по SSH Вывести
Имя того кто выполнял задачу
вывести показатель LA на сервере
вывести статистику по занятому месту

### Ответы

1.

```sh
groupadd tpk_user
groupadd tpk_test
groupadd tpk_admin
```
Проверим, что группы добавлены:
```sh
cat /etc/group
```
Или вывод той же команды только с указанием групп.
```sh
cat /etc/group | sed s/:.*//
```
В результате выполнения этой команды будет выведен список из групп, без лишней информации.
2.

```sh
mkdir /home/tpkpractic
useradd -d /home/tpkpractic -c zadanie2 -p paeloPhu7soodoo7 -s /bin/false -G tpk_user,tpk_test tpkpractic
echo "/bin/false" > /etc/shells
```

3.

```sh
useradd -m -c zadanie3 -p paeloPhu7soodoo7 -s /bin/bash -G tpk_user,tpk_admin tpkpractic2
```

4. 

```sh
touch /home/tpkpractic/test_file
chown tpkpractic2:tpk_user /home/tpkpractic/test_file
chmod 644 /home/tpkpractic/test_file
```

5.

```sh
groupadd allusers
```
Bash-скрипт script_users.sh:
```sh
#!/bin/bash

for ((i=0; i<=9; i++))
do
pass=$(pwgen 16 1)
/usr/sbin/useradd -m -s /bin/bash -p $pass -G allusers user$i
echo user$i $pass "/home/user"$i
done
```
Назначаем права на исполнение скрипта.
```sh
chmod +x script_users.sh
```
Запуск скрипта:
```sh
sh script_users.sh
```

6.

С помощью команды `visudo` запускаем редактирование `/etc/sudoers` и добавляем следующую запись.
```sh
tpkpractic2 ALL=(root) NOPASSWD: /usr/sbin/usermod
```
Сохраняем файл и проверяем:
```
[root@travin ~]# su - tpkpractic2

[tpkpractic2@travin ~]$ sudo usermod
Usage: usermod [options] LOGIN

Options:
  -c, --comment COMMENT         new value of the GECOS field
  -d, --home HOME_DIR           new home directory for the user account
  -e, --expiredate EXPIRE_DATE  set account expiration date to EXPIRE_DATE
  -f, --inactive INACTIVE       set password inactive after expiration
                                to INACTIVE
  -g, --gid GROUP               force use GROUP as new primary group
  -G, --groups GROUPS           new list of supplementary GROUPS
  -a, --append                  append the user to the supplemental GROUPS
                                mentioned by the -G option without removing
                                him/her from other groups
  -h, --help                    display this help message and exit
  -l, --login NEW_LOGIN         new value of the login name
  -L, --lock                    lock the user account
  -m, --move-home               move contents of the home directory to the
                                new location (use only with -d)
  -o, --non-unique              allow using duplicate (non-unique) UID
  -p, --password PASSWORD       use encrypted password for the new password
  -R, --root CHROOT_DIR         directory to chroot into
  -s, --shell SHELL             new login shell for the user account
  -u, --uid UID                 new UID for the user account
  -U, --unlock                  unlock the user account
  -Z, --selinux-user SEUSER     new SELinux user mapping for the user account
```

7.

Создадим файл с баннером
```sh
touch /etc/ssh/sshd-banner
```
и добавим в него строчку, например `This work was done by Roman Travin` и сохраним. 
После этого добавим в файл конфигурации ssh сервера директиву с указанием на файл баннера.
```sh
vim /etc/ssh/sshd_config
```
Добавим следующую строку
```sh
Banner /etc/ssh/sshd-banner
```
и перезагрузим ssh сервер.
```sh
service sshd restart
```
После выполненных действий пробуем подключиться по ssh к серверу и наблюдаем сообщение банера.
```
$ ssh root@176.99.5.222
This work was done by Roman Travin.
root@176.99.5.222's password: 
```

8.

Создаем скрипт `/etc/motd.sh`.
```sh
#!/bin/bash

LOAD1=`cat /proc/loadavg | awk {'print $1'}`
LOAD5=`cat /proc/loadavg | awk {'print $2'}`
LOAD15=`cat /proc/loadavg | awk {'print $3'}`
root_usage_percent=`df -h / | awk '/\// {print $(NF-1)}'`
root_usage_gb=`df -h / | awk '/\// {print $4}'|grep -v "^$"`
ROMLOST=`df -Ph`

figlet $(hostname)
printf "Name:\t\t%s" "Roman Travin"
printf "\n"
printf "System load:\t%s %s %s %s\t" $LOAD1, $LOAD5, $LOAD15
printf "\n"
printf "FS usage:\t%s %s %s" $root_usage_gb "is" $root_usage_percent
printf "\n"
```
Также для отображения hostname был использован пакет figlet из репозитория epel
```
yum -y install epel-release
yum install figlet
```
Добавляем скрипт `/etc/modt.sh` в файл `/etc/profile`.
В файле конфигурации ssh `/etc/ssh/sshd_config` устанавливаем директиву PrintMotd со значением yes.
```sh
vim /etc/ssh/sshd_config
```
Раскоментируем директиву и даем ей значени yes
```sh
PrintMotd yes
```
После чего перезагружаем ssh сервер.
```sh
service sshd restart
```
Проверяем, подключившись по ssh:
```
$ ssh root@176.99.5.222
This work was done by Roman Travin.
root@176.99.5.222's password: 
Last failed login: Tue Jan  1 12:27:54 MSK 2019 from 193.105.134.97 on ssh:notty
There were 116 failed login attempts since the last successful login.
Last login: Tue Dec 25 18:58:51 2018 from 46.20.68.157

 _                   _                  _                                    
| |_ _ __ __ ___   _(_)_ __    ___ ___ | | ___   _ __ ___  __ _   _ __ _   _ 
| __| '__/ _` \ \ / / | '_ \  / __/ _ \| |/ _ \ | '__/ _ \/ _` | | '__| | | |
| |_| | | (_| |\ V /| | | | || (_| (_) | | (_) || | |  __/ (_| |_| |  | |_| |
 \__|_|  \__,_| \_/ |_|_| |_(_)___\___/|_|\___(_)_|  \___|\__, (_)_|   \__,_|
                                                          |___/              
Name:		Roman Travin
System load:	0.00, 0.01, 0.05 	
FS usage:	8,3G is 11%
[root@travin ~]#
```

## Источники

1. [Пользователи и группы](https://help.ubuntu.ru/wiki/%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D0%BE%D0%B2%D0%B0%D1%82%D0%B5%D0%BB%D0%B8_%D0%B8_%D0%B3%D1%80%D1%83%D0%BF%D0%BF%D1%8B)
2. [Users and groups (Русский)](https://wiki.archlinux.org/index.php/Users_and_groups_(%D0%A0%D1%83%D1%81%D1%81%D0%BA%D0%B8%D0%B9))
3. [Создание пользователей через скрипт](https://forum.altlinux.org/index.php?topic=21176.0)
4. [Скрипт "создание пользователей"](http://www.cyberforum.ru/shell/thread1625405.html)