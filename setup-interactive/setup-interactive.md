## Интерактивная установка программного RAID-массива с LVM в Debian-based OS
В системе используется 4 диска: sda, sdb, sdc, sdd. 
**Техническое задание (далее ТЗ)**
Необходимо выполнить разметку диска согласно следующим данным:

|     Диски    	| Наименование дисков 	| Уровень RAID 	|                                            Разметка                                           	|
|:------------:	|:-------------------:	|:------------:	|:---------------------------------------------------------------------------------------------:	|
|  2 X 240 SSD 	|       sda, sdb      	|       1      	| /boot 512 Mb ext2, LVM: swap 16 Gb, / 30 Gb ext4, /opt - все остальное пространство в массиве 	|
| 2 X 500 SATA 	|       sdc, sdd      	|       0      	| /data - все место в массиве                                                                   	|
Загружаемся с PXE образа или образа дистрибутива. Далее идёт алгоритм действий после обнаружения дисков системой.
В появившемся окне установщика нажимаем **Continue**, после него появится следующее сообщение.
![Загрузка](1.png)
Нажимаем **Start installer**. После этого увидим следующее окно.
![Начало](2.png)
В системе используются 4 диска. Необходимо создать таблицу разделов на каждом из них. Для этого выбираем диск и на сообщение о создании пустой таблицы разделов отвечаем **Yes**. Повторяем создание таблицы для всех дисков.
![Разметка](3.gif)
После того, как все диски размечены приступаем к формированию разделов на дисках. Диски sda и sdb будут использоваться для установки ОС:
1. Выбираем свободное пространство на диске,
2. Нажимаем **Create a new partition**,
3. Для раздела /boot по ТЗ необходимо 512 Mb.
 - Вводим *512 M*, нажимаем **Continue**,
 - тип раздела выбираем **Primary**,
 - размещение раздела выбираем **Beginning**,
 - Параметр **Use as** устанавливаем **physical volume for RAID**,
 - Применяем разметку, нажимаем **Done setting up the partion**,
![Разметка /boot](4.gif)
4. Так как разделы swap, /, /opt будут находится в RAID-массиве внутри LVM, то все остально пространство в массиве необходимо выделить для данных разделов. Повторяем действия, указанные в предыдущем пункте, но на этапе выделения пространства под раздел - устанавливаем все имеющееся пространство.
![Разметка остальная](5.gif)
5. Повторить действия по разметке /boot, (swap, /, /opt) для диска sdb.
6. По ТЗ диски sdc и sdd также должны быть объединены в RAID-массив. Повторяем пукт 3 для дисков sdc и sdd. Тип раздела вместо **Primary** устанавливаем **Logical**, т.к. данные диски не системные.
7. После того, как разделы сформированы, меню разметки дисков будет иметь следующий вид:
![Подготовка разделов](6.png)
8. Далее необходимо создать программный RAID-массив. 
 - Переходим в **Configure software RAID**, принимаем запись на диски - жмём **Yes**,
 - Создаём RAID-массив для раздела /boot, нажимаем **Create MD devie**,
 - Выбираем **RAID-1**, число активных устройств оставляем 2 (для данной конфигурации RAID), жмём **Continue**
 - Выбираем разделы для boot на дисках sda и sdb (они имеют одинаковый индекс - 1), жмём **Continue**. Нажимаем **Finish**.
![Создаём boot-RAID](7.gif)
12. Повторяем действия для будущих разделов swap, /, /opt. Нажимаем **Finish**.
![Создаём RAID](8.gif)
14. Далее необходимо аналогично собрать RAID-0 из sdc и sdd. Повторяем пункт 8, на этапе выбора уровня RAID выбираем **RAID-0**. 
![RAID sdc и sdd](9.gif)
15. Согласно ТЗ необходимо раздел /boot оставить вне LVM.
 - Переходим в раздел RAID для /boot,
 - Параметр **Use as:** выбираем **Ext2 file system**,
 - **Mount point** выбираем **/boot**. 
 - После этого нажимаем **Done setting up the partition**.
![Выбор /boot](10.gif)
16. Далее переходим к конфигурированию LVM.
 - Переходим в **Configure the Logical Volume Manager**,
 - На вопрос о записи данных о LVM на диски нажимаем **Yes**,
 - Создаём группу LVM. Нажимаем **Create volume group**,
 - Вводим название группы. Например, `d41988` (номер сервера), нажимаем **Continue**,
 - Согласно ТЗ в группе LVM должны находится swap, /root и /opt разделы, поэтому в следующем окне выбираем `dev/md1` -  созданный ранее раздел для RAID. Нажимаем **Continue**,
![Создание группы](11.gif)
17. Следующим шагом будет создание логических томов.
 - Нажимаем **Create logical volume**,
 - Выбираем созданную группу,
 - Вводим имя логического тома. Для удобства вводим такое же имя, как и у будущего раздела внутри этого тома - `swap`.
 - Значение размера вводим 16 G, согласно ТЗ, нажимаем **Continue**.
![Создание тома swap](12.gif)
18. Повторяем для /root.
![Создание тома /root](13.gif)
19. Повторяем для /opt.Нажимаем **Finish**.
![Создание тома /opt](14.gif)
20. Для созданных томов LVM указываем точки монтирования swap и root и используемую файловую систему. Алгоритм действий аналогичен пункту 15.
 - Создаём раздел swap в LVM:
![Создание разделов в LVM](15.gif)
 - Создаём раздел /root в LVM:
![Создание разделов в LVM](16.gif)
 - Создаём раздел /opt в LVM:
![Создание разделов в LVM](17.gif)
21. Дискам sdc и sdd (2) необходимо назначить точку монтирования /data
 - Выбираем RAID-массив, созданный на sdd и sde (2),
 - **Use as:** устанавливаем **Ext4 journaling file system**
 - Переходим в **Mount point:**. Так как точки монтирования нет среди предложенных установщиком, то вводим её вручную - нажимаем **Enter manually** и вписываем **/data**, нажимаем **Continue**.
 - После этого нажимаем **Done setting up the partition**.
![18](18.gif)

После всех выполненных действий нажимаем **Finish partitioning and write changes to disk**, соглашаемся с изменениями устанавливаемыми на диск - нажимаем **Yes** и дожидаемся установки операционной системы.

После установки проверяем корректность разбивки на сервере:
```sh
root@cats:~# cat /proc/mdstat
Personalities : [raid1] [raid0] [linear] [multipath] [raid6] [raid5] [raid4] [raid10] 
md2 : active raid0 sdc5[0] sdd5[1]
      976506880 blocks super 1.2 512k chunks
      
md1 : active raid1 sda2[0] sdb2[1]
      233799680 blocks super 1.2 [2/2] [UU]
      bitmap: 0/2 pages [0KB], 65536KB chunk

md0 : active raid1 sda1[0] sdb1[1]
      498368 blocks super 1.2 [2/2] [UU]
      
unused devices: <none>
root@cats:~# lsblk
NAME              MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda                 8:0    0 223.6G  0 disk  
├─sda1              8:1    0   487M  0 part  
│ └─md0             9:0    0 486.7M  0 raid1 /boot
└─sda2              8:2    0 223.1G  0 part  
  └─md1             9:1    0   223G  0 raid1 
    ├─d41988-root 252:0    0    28G  0 lvm   /
    ├─d41988-swap 252:1    0  14.9G  0 lvm   [SWAP]
    └─d41988-opt  252:2    0 180.1G  0 lvm   /opt
sdb                 8:16   0 223.6G  0 disk  
├─sdb1              8:17   0   487M  0 part  
│ └─md0             9:0    0 486.7M  0 raid1 /boot
└─sdb2              8:18   0 223.1G  0 part  
  └─md1             9:1    0   223G  0 raid1 
    ├─d41988-root 252:0    0    28G  0 lvm   /
    ├─d41988-swap 252:1    0  14.9G  0 lvm   [SWAP]
    └─d41988-opt  252:2    0 180.1G  0 lvm   /opt
sdc                 8:32   0 465.8G  0 disk  
├─sdc1              8:33   0     1K  0 part  
└─sdc5              8:37   0 465.8G  0 part  
  └─md2             9:2    0 931.3G  0 raid0 /data
sdd                 8:48   0 465.8G  0 disk  
├─sdd1              8:49   0     1K  0 part  
└─sdd5              8:53   0 465.8G  0 part  
  └─md2             9:2    0 931.3G  0 raid0 /data
sr0                11:0    1  1024M  0 rom   
```

Как видно, созданные разделы полностью совпадают с техническим заданием.

## Интерактивная установка программного RAID-массива с LVM в Cent OS
В системе используется 4 диска: sda, sdb, sdc, sdd. 
**Техническое задание (далее ТЗ)**
Необходимо выполнить разметку диска согласно следующим данным:

|     Диски    	| Наименование дисков 	| Уровень RAID 	|                                            Разметка                                           	|
|:------------:	|:-------------------:	|:------------:	|:---------------------------------------------------------------------------------------------:	|
|  2 X 240 SSD 	|       sda, sdb      	|       1      	| /boot 512 Mb ext2, LVM: swap 16 Gb, / 30 Gb ext4, /opt - все остальное пространство в массиве 	|
| 2 X 500 SATA 	|       sdc, sdd      	|       0      	| /data - все место в массиве                                                                   	|
Загружаемся с PXE образа или образа дистрибутива. При загрузке образа PXE будет предложен пароль VNC для дальнейшей установки ОС через клиент VNC. Необходимо записать данный пароль. Когда система будет загружена для установки в консоли IPMI/KVM будет следующее сообщение. 
![](1c.png)
Используя VNC-клиент (Remmina, VNCviewer) подключаемся к серверу. После подключения -  видим окно установкщика.
![](2с.png)
На данном этапе все необходимые настройки уже введены для установки ОС, осталось только разметить диски.
1. Нажимаем **Installation destinantion**.
2. В следующем окне проверяем, что все диски выбраны для работы с ними. Если какой либо из дисков не выбран - нажимаем на него - появится обозначение, что диск выбран. После этого нажимаем **Done**.
![](3c.png)
3. В следующем окне проверяем еще раз, что все диски выбраны и выбран диск для установки загрузчика.
![](4c.gif)
4. Создаём раздел /boot:
 - Нажимаем **+**,
 - **Mount point** выбираем из выпадающего списка /boot,
 - **Desired Capasity** устанавливаем согласно ТЗ - в данном случае 512 M и нажимаем **Add mount point**.
 - В следующем окне в поле **File system** устаналиваем тип файловой системы **ext2** - согласно ТЗ,
 - Тип устройства **Device Type** устанавливаем **RAID**, уровень RAID **RAID Level** - RAID1 - согласно ТЗ,
 - Так как раздел /boot устанавливается только на системные диски sda и sdb, то необходимо выбрать установку именно на них. Для этого нажимаем **Modify...** и выбираем sda и sdb диски и нажимаем **Select**,
 - Нажимаем **Update settings**, чтобы обновить настройки раздела.
5. Создаём раздел swap:
 - Нажимаем **+**,
 - **Mount point** выбираем из выпадающего списка swap,
 - **Desired Capasity** устанавливаем согласно ТЗ - в данном случае 16 G и нажимаем **Add mount point**,
 -В следующем окне в поле **File system** устаналиваем тип файловой системы **swap** - согласно ТЗ,
 - Согласно ТЗ раздел swap должен принадлежать логической группе (LVM), поэтому **Device type** устанавливаем LVM,
 - В разделе **Volume Group** нажимаем **Modify** и устанавливаем имя логическое группы, например номер сервера, выбираем диски, на которые будет записана логический том (в данном случае sda и sdb), **RAID Level** устанавливаем RAID1 и нажимаем **Save**.
![](5c.gif)
6. Создаём раздел /:
 - Нажимаем **+**,
 - **Mount point** выбираем из выпадающего списка /,
 - **Desired Capasity** устанавливаем согласно ТЗ - в данном случае 30 G и нажимаем **Add mount point**.
 - В следующем окне в поле **File system** устаналиваем тип файловой системы **ext4** - согласно ТЗ,
 - Согласно ТЗ раздел / должен принадлежать логической группе (LVM), поэтому **Device type** устанавливаем LVM,
 - В разделе **Volume Group** нажимаем **Modify** и устанавливаем имя логическое группы, например номер сервера, выбираем диски, на которые будет записана логический том (в данном случае sda и sdb), **RAID Level** устанавливаем RAID1 и нажимаем **Save**.
![](6c.gif)
7. Создаём раздел /opt:
 - Нажимаем **+**,
 - **Mount point** вводим вручную /opt,
 - **Desired Capasity** оставляем поле пустым, нажимаем **Add mount point**.
 - В следующем окне в поле **File system** устаналиваем тип файловой системы **ext4** - согласно ТЗ,
 - Согласно ТЗ раздел /opt должен принадлежать логической группе (LVM), поэтому **Device type** устанавливаем LVM,
 - В разделе **Volume Group** нажимаем **Modify** и устанавливаем имя логическое группы, например номер сервера, выбираем диски, на которые будет записана логический том (в данном случае sda и sdb), **RAID Level** устанавливаем RAID1 и нажимаем **Save**.
![](7c.gif)
8. Создаём раздел /data:
 - Нажимаем **+**,
 - **Mount point** вводим вручную /data,
 - В поле **Desired Capasity** вводим остальное дисковое пространство на дисках sdc и sdd, нажимаем **Add mount point**.
 - В следующем окне в поле **File system** устаналиваем тип файловой системы **ext4** - согласно ТЗ,
 - Тип устройства **Device Type** устанавливаем **RAID**, уровень RAID **RAID Level** - RAID0 - согласно ТЗ,
 - Так как раздел /data устанавливается только на диски sdc и sdd, то необходимо выбрать установку именно на них. Для этого нажимаем **Modify...** и выбираем sdc и sdd диски и нажимаем **Select**,
 - Нажимаем **Update settings**, чтобы обновить настройки раздела.
 - После установки параметров нажимаем **Done**, проверяем изменения и нажимаем **Accept Changes**,
 - Нажимаем **Begin Installation** и дожидаемся окончания установки.
![](8c.gif)

После установки делаем перезагрузку системы и проверяем корректность разметки дисков.
```
[root@cats ~]# cat /proc/mdstat
Personalities : [raid1] [raid0] 
md124 : active raid1 sda1[0] sdb1[1]
      185543680 blocks super 1.2 [2/2] [UU]
      	resync=DELAYED
      bitmap: 2/2 pages [8KB], 65536KB chunk

md125 : active raid0 sdd1[1] sdc1[0]
      976506880 blocks super 1.2 512k chunks
      
md126 : active raid1 sda2[0] sdb2[1]
      48190464 blocks super 1.2 [2/2] [UU]
      [=========>...........]  resync = 48.5% (23402624/48190464) finish=5.5min speed=74268K/sec
      bitmap: 1/1 pages [4KB], 65536KB chunk

md127 : active raid1 sda3[0] sdb3[1]
      524288 blocks super 1.2 [2/2] [UU]
      bitmap: 0/1 pages [0KB], 65536KB chunk

unused devices: <none>
[root@cats ~]# lsblk
NAME            MAJ:MIN RM   SIZE RO TYPE  MOUNTPOINT
sda               8:0    0 223,6G  0 disk  
├─sda1            8:1    0 177,1G  0 part  
│ └─md124         9:124  0   177G  0 raid1 /opt
├─sda2            8:2    0    46G  0 part  
│ └─md126         9:126  0    46G  0 raid1 
│   ├─cats-root 253:0    0    30G  0 lvm   /
│   └─cats-swap 253:1    0    16G  0 lvm   [SWAP]
└─sda3            8:3    0   513M  0 part  
  └─md127         9:127  0   512M  0 raid1 /boot
sdb               8:16   0 223,6G  0 disk  
├─sdb1            8:17   0 177,1G  0 part  
│ └─md124         9:124  0   177G  0 raid1 /opt
├─sdb2            8:18   0    46G  0 part  
│ └─md126         9:126  0    46G  0 raid1 
│   ├─cats-root 253:0    0    30G  0 lvm   /
│   └─cats-swap 253:1    0    16G  0 lvm   [SWAP]
└─sdb3            8:19   0   513M  0 part  
  └─md127         9:127  0   512M  0 raid1 /boot
sdc               8:32   0 465,8G  0 disk  
└─sdc1            8:33   0 465,8G  0 part  
  └─md125         9:125  0 931,3G  0 raid0 /data
sdd               8:48   0 465,8G  0 disk  
└─sdd1            8:49   0 465,8G  0 part  
  └─md125         9:125  0 931,3G  0 raid0 /data
sr0              11:0    1  1024M  0 rom   
```

>? Если в системе используются диски объёмом более чем 2 Tb, то следует использовать таблицу разметки GPT. Также следуюет добавить раздел biosboot. При установке bioisboot на системные диски может возникнуть проблема, описаннная в статье [Установка CentOS 6/7 c Software RAID (biosboot problem)](https://cloud-core.ru/kb/ustanovka-centos-c-programmnym-raid-biosboot-problem). Также в этой статье рассматривается способ решения проблемы.